import os
import stat
from pathlib import Path

from autodoc.utils.logger import setup_logger

logger = setup_logger()


def init_project():
    """
    Installs the git hook in the current repository.
    """
    hook_path = Path(".git/hooks/post-commit")

    if not Path(".git").exists():
        logger.error("Not a git repository. Run 'git init' first.")
        return

    logger.info(f"Installing post-commit hook to {hook_path}...")

    hook_content = """#!/bin/bash
# Auto-Doc Hook
# Generated by 'autodoc init'

# Load Environment Variables from .env if present
if [ -f .env ]; then
    export $(grep -v '^#' .env | xargs)
fi

# Fallback: Check shell profiles if key is missing
if [ -z "$GEMINI_API_KEY" ]; then
    CONFIG_FILES=("$HOME/.zshrc" "$HOME/.bashrc" "$HOME/.bash_profile" "$HOME/.profile")
    for file in "${CONFIG_FILES[@]}"; do
        if [ -f "$file" ]; then
            KEY_IN_FILE=$(grep "export GEMINI_API_KEY" "$file" | head -n 1)
            if [ -n "$KEY_IN_FILE" ]; then
                EXTRACTED_KEY=$(echo "$KEY_IN_FILE" | sed -E 's/^export GEMINI_API_KEY=//' | tr -d \\'\\"\\' | tr -d \\"\\'\\")
                if [ -n "$EXTRACTED_KEY" ]; then
                    export GEMINI_API_KEY="$EXTRACTED_KEY"
                    break
                fi
            fi
        fi
    done
fi

if [ -z "$GEMINI_API_KEY" ]; then
    echo "⚠️  Auto-Doc Agent: GEMINI_API_KEY not found. Skipping."
    exit 0
fi

# Run the sync command
# We assume 'autodoc' is in the path (installed in venv)
autodoc sync
"""

    try:
        hook_path.write_text(hook_content, encoding="utf-8")
        # Make executable
        st = os.stat(hook_path)
        os.chmod(hook_path, st.st_mode | stat.S_IEXEC)
        logger.info("✅ Hook installed successfully.")
    except Exception as e:
        logger.error(f"Failed to install hook: {e}")
